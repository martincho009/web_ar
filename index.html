<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WebAR Demo - M√∫ltiples Marcadores (MODERNIZADO)</title>
    
    <!-- üöÄ VERSIONES MODERNAS 2025 -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- Componente de gestos para A-Frame -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 1;
            max-width: 280px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        #info h3 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #4CAF50;
        }
        
        #info ul {
            margin: 8px 0;
            padding-left: 18px;
        }
        
        #info li {
            margin-bottom: 4px;
        }
        
        #info .gesture-info {
            background: rgba(76, 175, 80, 0.2);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            border-left: 3px solid #4CAF50;
        }
        
        #info small {
            color: #ffeb3b;
        }
        
        .version-badge {
            background: linear-gradient(45deg, #4CAF50, #2196F3);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: Arial, sans-serif;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <!-- Loading overlay -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div>üöÄ Iniciando WebAR moderno...</div>
        <div style="font-size: 12px; margin-top: 10px; opacity: 0.7;">A-Frame 1.6.0 + AR.js 2025</div>
    </div>
    
    <div id="info">
        <h3>üì± WebAR Moderno <span class="version-badge">2025</span></h3>
        <strong>Marcadores disponibles:</strong>
        <ul>
            <li>üéØ Hiro ‚Üí Modelo Base</li>
            <li>üà∑Ô∏è Kanji ‚Üí Modelo Base</li>
            <li>üì± QR #6 ‚Üí Buster Drone</li>
        </ul>
        
        <div class="gesture-info">
            <strong>üéÆ Controles t√°ctiles:</strong><br>
            ‚Ä¢ <strong>1 dedo:</strong> Rotar modelo<br>
            ‚Ä¢ <strong>2 dedos:</strong> Pellizcar para escalar
        </div>
        
        <small>‚ö†Ô∏è Usa papel blanco mate sin reflejos</small>
    </div>
    
    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best; detectionMode: color_and_matrix;"
        gesture-detector
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; physicallyCorrectLights: true; alpha: true; antialias: true;">
        
        <!-- Assets -->
        <a-assets>
            <a-asset-item id="modelo3d" src="assets/base_basic_pbr.glb"></a-asset-item>
            <a-asset-item id="drone-modelo" src="assets/buster_drone.glb"></a-asset-item>
        </a-assets>
        
        <!-- Marcador Hiro con modelo base -->
        <a-marker preset="hiro">
            <a-entity 
                id="modelo-hiro"
                gltf-model="#modelo3d"
                position="0 0 0"
                scale="0.3 0.3 0.3"
                rotation="0 0 0"
                gesture-handler="minScale: 0.1; maxScale: 2"
                class="clickable"
                animation-mixer>
            </a-entity>
            
            <a-light type="ambient" color="#ffffff" intensity="0.6"></a-light>
            <a-light type="directional" position="1 1 1" color="#ffffff" intensity="0.4"></a-light>
        </a-marker>
        
        <!-- Marcador Kanji con modelo base -->
        <a-marker preset="kanji">
            <a-entity 
                id="modelo-kanji"
                gltf-model="#modelo3d"
                position="0 0 0"
                scale="0.3 0.3 0.3"
                rotation="0 0 0"
                gesture-handler="minScale: 0.1; maxScale: 2"
                class="clickable"
                animation-mixer>
            </a-entity>
            
            <a-light type="ambient" color="#ffffff" intensity="0.6"></a-light>
            <a-light type="directional" position="1 1 1" color="#ffffff" intensity="0.4"></a-light>
        </a-marker>
        
        <!-- Marcador QR #6 con Buster Drone -->
        <a-marker type="barcode" value="6">
            <a-entity 
                id="modelo-qr6"
                gltf-model="#drone-modelo"
                position="0 0 0"
                scale="0.5 0.5 0.5"
                rotation="0 0 0"
                gesture-handler="minScale: 0.1; maxScale: 3"
                class="clickable"
                animation-mixer>
            </a-entity>
            
            <!-- Iluminaci√≥n especial para el drone -->
            <a-light type="ambient" color="#ffffff" intensity="0.7"></a-light>
            <a-light type="directional" position="2 2 2" color="#ffffff" intensity="0.5"></a-light>
            <a-light type="point" position="0 2 0" color="#ffffff" intensity="0.3"></a-light>
        </a-marker>
        
        <a-entity camera></a-entity>
    </a-scene>
    
    <script>
        // üöÄ C√ìDIGO MODERNIZADO PARA A-FRAME 1.6.0
        
        // Ocultar loading despu√©s de que se inicialice
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.style.opacity = '0';
                    setTimeout(() => loading.remove(), 500);
                }
            }, 2000);
        });
        
        // Registrar el componente gesture-detector (MEJORADO)
        AFRAME.registerComponent('gesture-detector', {
            init: function () {
                this.handleStart = this.handleStart.bind(this);
                this.handleEnd = this.handleEnd.bind(this);
                this.handleMove = this.handleMove.bind(this);
                
                this.el.addEventListener('touchstart', this.handleStart);
                this.el.addEventListener('touchend', this.handleEnd);
                this.el.addEventListener('touchmove', this.handleMove);
                
                console.log('‚úÖ Gesture detector moderno inicializado');
            },
            
            handleStart: function (evt) {
                this.initialTouchDistance = null;
                this.initialScale = null;
            },
            
            handleMove: function (evt) {
                if (evt.touches.length === 2) {
                    evt.preventDefault();
                    
                    const touch1 = evt.touches[0];
                    const touch2 = evt.touches[1];
                    const distance = Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                    
                    if (this.initialTouchDistance === null) {
                        this.initialTouchDistance = distance;
                        // Buscar cualquier modelo visible (OPTIMIZADO)
                        const modelos = document.querySelectorAll('[id^="modelo-"]');
                        for (let modelo of modelos) {
                            const marker = modelo.closest('a-marker');
                            if (marker && marker.object3D.visible) {
                                this.activeModel = modelo;
                                this.initialScale = modelo.getAttribute('scale');
                                break;
                            }
                        }
                    }
                    
                    if (this.activeModel && this.initialScale) {
                        const scaleFactor = distance / this.initialTouchDistance;
                        const gestureData = this.activeModel.getAttribute('gesture-handler');
                        const minScale = gestureData ? gestureData.minScale : 0.1;
                        const maxScale = gestureData ? gestureData.maxScale : 3;
                        
                        const newScale = Math.max(minScale, Math.min(maxScale, 
                            this.initialScale.x * scaleFactor));
                        
                        this.activeModel.setAttribute('scale', {
                            x: newScale,
                            y: newScale,
                            z: newScale
                        });
                    }
                }
            },
            
            handleEnd: function (evt) {
                this.initialTouchDistance = null;
                this.initialScale = null;
                this.activeModel = null;
            }
        });
        
        // Registrar el componente gesture-handler (MEJORADO)
        AFRAME.registerComponent('gesture-handler', {
            schema: {
                minScale: {default: 0.1},
                maxScale: {default: 3}
            },
            
            init: function () {
                this.handleRotate = this.handleRotate.bind(this);
                this.isVisible = false;
                
                // Mejor compatibilidad con A-Frame 1.6.0
                this.el.sceneEl.addEventListener('enter-vr', () => {
                    this.isVisible = false;
                });
                
                this.el.sceneEl.addEventListener('exit-vr', () => {
                    this.isVisible = false;
                });
                
                this.el.addEventListener('touchstart', this.handleRotate);
                
                console.log('‚úÖ Gesture handler moderno para:', this.el.id);
            },
            
            handleRotate: function (evt) {
                if (evt.touches.length === 1) {
                    evt.preventDefault();
                    
                    // Verificar que el modelo est√© visible
                    const marker = this.el.closest('a-marker');
                    if (!marker || !marker.object3D.visible) return;
                    
                    this.initialMouseX = evt.touches[0].clientX;
                    this.initialMouseY = evt.touches[0].clientY;
                    
                    const onMouseMove = (e) => {
                        e.preventDefault();
                        const touch = e.touches[0];
                        const deltaX = touch.clientX - this.initialMouseX;
                        const deltaY = touch.clientY - this.initialMouseY;
                        
                        const currentRotation = this.el.getAttribute('rotation');
                        this.el.setAttribute('rotation', {
                            x: currentRotation.x - deltaY * 0.5,
                            y: currentRotation.y + deltaX * 0.5,
                            z: currentRotation.z
                        });
                        
                        this.initialMouseX = touch.clientX;
                        this.initialMouseY = touch.clientY;
                    };
                    
                    const onMouseUp = () => {
                        document.removeEventListener('touchmove', onMouseMove);
                        document.removeEventListener('touchend', onMouseUp);
                    };
                    
                    document.addEventListener('touchmove', onMouseMove, {passive: false});
                    document.addEventListener('touchend', onMouseUp);
                }
            }
        });
        
        // üìä Log de informaci√≥n moderna
        console.log('üöÄ WebAR MODERNIZADO - Versi√≥n 2025');
        console.log('‚îú‚îÄ‚îÄ A-Frame: 1.6.0');
        console.log('‚îú‚îÄ‚îÄ AR.js: Master (2025)');
        console.log('‚îú‚îÄ‚îÄ Controles t√°ctiles: ‚úÖ Mejorados');
        console.log('‚îú‚îÄ‚îÄ Detecci√≥n: ‚úÖ Optimizada');
        console.log('‚îî‚îÄ‚îÄ Compatibilidad: ‚úÖ Moderna');
        
        // Performance monitoring (opcional)
        window.addEventListener('load', () => {
            console.log('‚ö° WebAR cargado completamente');
        });
    </script>
</body>
</html> 